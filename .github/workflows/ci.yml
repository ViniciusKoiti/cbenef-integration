# .github/workflows/release.yml
name: ðŸš€ Release Pipeline

on:
  push:
    tags:
      - 'v*.*.*'  # Dispara apenas quando uma tag de versÃ£o Ã© criada (ex: v1.2.0)

env:
  GRADLE_OPTS: -Dorg.gradle.daemon=false -Xmx2g -Xms1g

jobs:
  # ============================================================================
  # JOB 1: VALIDAÃ‡ÃƒO E TESTES
  # ============================================================================
  validate:
    name: ðŸ” ValidaÃ§Ã£o e Testes
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          gradle-version: 8.14

      - name: ðŸ“‹ Validar Gradle Wrapper
        uses: gradle/wrapper-validation-action@v1

      - name: ðŸ§¹ Clean & Build
        run: ./gradlew clean build

      - name: ðŸ§ª Executar Testes
        run: ./gradlew test

      - name: ðŸ“Š Gerar RelatÃ³rio de Testes
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: ðŸ“‹ RelatÃ³rio de Testes
          path: build/test-results/test/*.xml
          reporter: java-junit

      - name: ðŸ” Verificar Extratores
        run: ./gradlew test --tests "*ExtractorTest"

  # ============================================================================
  # JOB 2: BUILD E PUBLICAÃ‡ÃƒO
  # ============================================================================
  release:
    name: ðŸ“¦ Build e Release
    runs-on: ubuntu-latest
    needs: validate

    outputs:
      version: ${{ steps.get_version.outputs.version }}

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # NecessÃ¡rio para tags

      - name: â˜• Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: ðŸ˜ Setup Gradle
        uses: gradle/gradle-build-action@v2

      - name: ðŸ·ï¸ Extrair versÃ£o da tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“‹ VersÃ£o: $VERSION"

      - name: âœï¸ Atualizar versÃ£o no build.gradle.kts
        run: |
          sed -i "s/version = \".*\"/version = \"${{ steps.get_version.outputs.version }}\"/" build.gradle.kts
          echo "ðŸ“ VersÃ£o atualizada para: ${{ steps.get_version.outputs.version }}"

      - name: ðŸ”¨ Build completo
        run: ./gradlew clean build -x test

      - name: ðŸ“š Gerar Javadoc
        run: ./gradlew javadoc

      - name: ðŸ“¦ Publicar no GitHub Packages
        env:
          USERNAME: ${{ github.actor }}
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          ./gradlew publishGprPublicationToGitHubPackagesRepository \
            -Pgpr.user=$USERNAME \
            -Pgpr.key=$TOKEN

      - name: ðŸ“¤ Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ steps.get_version.outputs.version }}
          path: |
            build/libs/*.jar
            build/docs/javadoc/
          retention-days: 30

  # ============================================================================
  # JOB 3: GITHUB RELEASE
  # ============================================================================
  github-release:
    name: ðŸŽ‰ GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, release]

    steps:
      - name: ðŸ“¥ Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Artifacts
        uses: actions/download-artifact@v4
        with:
          name: build-artifacts-${{ needs.release.outputs.version }}
          path: ./artifacts

      - name: ðŸ“‹ Gerar Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## ðŸ†• CBenef Integration Library v${{ needs.release.outputs.version }}
          
          ### âœ¨ Novidades
          - VersÃ£o automatizada via GitHub Actions
          - Build e testes validados automaticamente
          - PublicaÃ§Ã£o simultÃ¢nea no GitHub Packages e JitPack
          
          ### ðŸ“Š Estados Ativos
          - ðŸŸ¢ **SC** (Santa Catarina) - ~150 benefÃ­cios
          - ðŸŸ¢ **ES** (EspÃ­rito Santo) - ~80 benefÃ­cios  
          - ðŸŸ¢ **RJ** (Rio de Janeiro) - ~120 benefÃ­cios
          - ðŸŸ¢ **PR** (ParanÃ¡) - ~200 benefÃ­cios
          
          **Total: ~550 benefÃ­cios fiscais automatizados!** ðŸŽ‰
          
          ### ðŸš€ InstalaÃ§Ã£o
          
          #### JitPack (Recomendado)
          ```gradle
          repositories {
              maven { url = uri("https://jitpack.io") }
          }
          
          dependencies {
              implementation("com.github.ViniciusKoiti:cbenef-integration:v${{ needs.release.outputs.version }}")
          }
          ```
          
          #### GitHub Packages
          ```gradle
          repositories {
              maven {
                  name = "GitHubPackages"
                  url = uri("https://maven.pkg.github.com/ViniciusKoiti/cbenef-integration")
                  credentials {
                      username = "seu_username"
                      password = "seu_token"
                  }
              }
          }
          
          dependencies {
              implementation("io.github.viniciuskoiti:cbenef-integration:${{ needs.release.outputs.version }}")
          }
          ```
          
          ### ðŸ”§ Exemplo de Uso
          ```kotlin
          val client = StandaloneCBenefClient()
          
          // Extrair todos os estados
          val beneficios = client.extrairTodosOsBeneficios()
          println("Total: \${beneficios.size} benefÃ­cios")
          
          // Extrair estado especÃ­fico
          val beneficiosPR = client.extrairPorEstado("PR")
          println("ParanÃ¡: \${beneficiosPR.size} benefÃ­cios")
          ```
          
          ### ðŸ“– DocumentaÃ§Ã£o
          - [README completo](https://github.com/ViniciusKoiti/cbenef-integration#readme)
          - [DocumentaÃ§Ã£o tÃ©cnica](https://github.com/ViniciusKoiti/cbenef-integration/wiki)
          
          ### ðŸ¤ Contribua
          - â­ Deixe uma estrela se o projeto foi Ãºtil
          - ðŸ› Reporte bugs ou problemas
          - ðŸ’¡ Sugira novos estados ou melhorias
          - ðŸ”§ Contribua com cÃ³digo
          
          ---
          **âš¡ Release automatizada via GitHub Actions** 
          EOF

      - name: ðŸŽ‰ Criar GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: v${{ needs.release.outputs.version }} - CBenef Integration
          body_path: release_notes.md
          draft: false
          prerelease: false

      - name: ðŸ“Ž Anexar JAR principal
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/cbenef-integration-${{ needs.release.outputs.version }}.jar
          asset_name: cbenef-integration-${{ needs.release.outputs.version }}.jar
          asset_content_type: application/java-archive

      - name: ðŸ“Ž Anexar Sources JAR
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./artifacts/cbenef-integration-${{ needs.release.outputs.version }}-sources.jar
          asset_name: cbenef-integration-${{ needs.release.outputs.version }}-sources.jar
          asset_content_type: application/java-archive

  # ============================================================================
  # JOB 4: VALIDAÃ‡ÃƒO JITPACK
  # ============================================================================
  validate-jitpack:
    name: âœ… Validar JitPack
    runs-on: ubuntu-latest
    needs: [release, github-release]

    steps:
      - name: â³ Aguardar build JitPack
        run: |
          echo "ðŸ• Aguardando JitPack processar o release..."
          sleep 60

      - name: ðŸ” Verificar disponibilidade JitPack
        run: |
          VERSION=${{ needs.release.outputs.version }}
          echo "ðŸ” Verificando JitPack para versÃ£o: $VERSION"
          
          # Tentar baixar os metadados
          curl -f -s "https://jitpack.io/api/builds/com.github.ViniciusKoiti/cbenef-integration/$VERSION" || {
            echo "âŒ JitPack ainda nÃ£o disponÃ­vel"
            echo "ðŸ”— Verifique manualmente: https://jitpack.io/#ViniciusKoiti/cbenef-integration"
            exit 1
          }
          
          echo "âœ… JitPack disponÃ­vel para v$VERSION"
          echo "ðŸ”— Link: https://jitpack.io/#ViniciusKoiti/cbenef-integration/$VERSION"

  # ============================================================================
  # JOB 5: NOTIFICAÃ‡Ã•ES
  # ============================================================================
  notify:
    name: ðŸ“¢ NotificaÃ§Ãµes
    runs-on: ubuntu-latest
    needs: [validate, release, github-release, validate-jitpack]
    if: always()

    steps:
      - name: ðŸŽ‰ Sucesso - Notificar
        if: needs.validate.result == 'success' && needs.release.result == 'success' && needs.github-release.result == 'success'
        run: |
          echo "ðŸŽ‰ Release v${{ needs.release.outputs.version }} publicado com sucesso!"
          echo "ðŸ“¦ GitHub Packages: âœ…"
          echo "ðŸ·ï¸ GitHub Release: âœ…"
          echo "ðŸ“‹ JitPack: âœ…"
          echo ""
          echo "ðŸ”— Links Ãºteis:"
          echo "   Release: https://github.com/ViniciusKoiti/cbenef-integration/releases/tag/v${{ needs.release.outputs.version }}"
          echo "   JitPack: https://jitpack.io/#ViniciusKoiti/cbenef-integration/${{ needs.release.outputs.version }}"

      - name: âŒ Falha - Notificar
        if: needs.validate.result == 'failure' || needs.release.result == 'failure' || needs.github-release.result == 'failure'
        run: |
          echo "âŒ Release v${{ needs.release.outputs.version }} falhou!"
          echo "ðŸ” Verifique os logs para detalhes"
          exit 1